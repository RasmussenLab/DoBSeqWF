// Execution specific profile parameters for DoBSeq pipeline
// mads 2024-02-08

// Base configuration with standard error strategy.

process {
    errorStrategy = { task.exitStatus in ((130..145) + 104) ? 'retry' : 'finish' }
    maxRetries    = 2
}

profiles {
    standard {
        conda.enabled = true

        params {
            outputDir = "results"
        }
        process {
            executor = 'local'

            withName: FASTQC {
                conda = "$projectDir/envs/fastqc/environment.yaml"
                cpus = 1
            }

            withName: ADAPTERREMOVAL {
                conda = "$projectDir/envs/misc/environment.yaml"
                cpus = 1
            }

            withName: MAPPING {
                conda = "$projectDir/envs/misc/environment.yaml"
                cpus = 1
            }

            withName: FILTER {
                conda = "$projectDir/envs/r_env/environment.yml"
                cpus = 10
            }

            withName: MULTIQC {
                conda = "$projectDir/envs/fastqc/environment.yaml"
                cpus = 1
            }

            withName: TEST {
                conda = "$projectDir/envs/r_env/environment.yaml"
                cpus = 1
            }

        }
    }

    ngc {
        params {
            outputDir = "results"
            project = ""
            cacheDir = "/home/projects/$params.project/scratch/nextflow"
        }

        process {
            executor = 'pbs'
            queueSize = 30
            beforeScript = "export _JAVA_OPTIONS=-Djava.io.tmpdir=$params.cacheDir"
            clusterOptions = "-A $params.project -W group_list=$params.project"
            
            withLabel: 'low_req' {
                executor = 'local'
            }

            withName: FASTQC {
                module = ['tools','java/1.8.0-openjdk','perl/5.30.2','fastqc/0.11.9']
                cpus = 1
                memory = 4.GB
                time = 2.hour
            }

            withName: ADAPTERREMOVAL {
                module = ['tools','gcc/10.2.0','AdapterRemoval/2.3.1','samtools/1.13', 'perl/5.30.2']
                cpus = 10
                memory = 10.GB
                time = 2.hour
            }

            withName: MAPPING {
                module = ['tools','gcc/10.2.0','bwa/0.7.17','samtools/1.13', 'perl/5.30.2','pigz/2.3.4']
                cpus = 40
                memory = 180.GB
                time = 8.hour
            }

            withName: FILTER {
                module = ['tools','gcc/7.2.0','intel/perflibs/2020_update4','R/4.1.0']
                cpus = 2
                memory = 10.GB
                time = 2.hour
            }

            withName: MULTIQC {
                module = ['tools','anaconda3/2021.11']
                cpus = 1
                memory = 4.GB
                time = 1.hour
            }

            withName: TEST {
                module = ['tools','gcc/7.2.0','intel/perflibs/2020_update4','R/4.1.0']
                cpus = 1
                memory = 10.GB
                time = 1.hour
            }
        }
    }

    test {
        params {
            samplelist = "$projectDir/assets/samplelist.tsv"
            sampletable = "$projectDir/assets/sampletable.tsv"
            doTest = true
        }
    }
}
