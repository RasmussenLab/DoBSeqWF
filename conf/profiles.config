// Execution specific profile parameters for DoBSeq pipeline
// mads 2024-02-08

// Base configuration with standard error strategy.

process {
    errorStrategy = { task.exitStatus in ((130..145) + 104) ? 'retry' : 'finish' }
    maxRetries    = 2
}

profiles {
    standard {
        conda.enabled = true

        params {
            outputDir = "results"
            resourceBase = "./resource_base"
        }
        process {
            executor = 'local'

            withName: FASTQC {
                conda = "$projectDir/envs/fastqc/environment.yaml"
                cpus = 1
            }

            withName: ALIGNMENT {
                conda = "$projectDir/envs/misc/environment.yaml"
                cpus = 1
            }

            withName: MARKDUPLICATES {
                conda = "$projectDir/envs/gatk4/environment.yaml"
                cpus = 1
            }

            withName: CLEAN {
                conda = "$projectDir/envs/misc/environment.yaml"
                cpus = 1
            }

            withName: ADDREADGROUP {
                conda = "$projectDir/envs/gatk4/environment.yaml"
                cpus = 1
            }

            withName: INDEX {
                conda = "$projectDir/envs/misc/environment.yaml"
                cpus = 1
            }

            withName: VALIDATE {
                conda = "$projectDir/envs/gatk4/environment.yaml"
                cpus = 1
            }

            withName: HAPLOTYPECALLER {
                conda = "$projectDir/envs/gatk4/environment.yaml"
                cpus = 1
            }

            withName: INDELQUAL {
                conda = "$projectDir/envs/lofreq/environment.yaml"
                cpus = 1
            }

            withName: LOFREQ {
                conda = "$projectDir/envs/lofreq/environment.yaml"
                cpus = 1
            }
            
            withName: PINNING {
                conda = "$projectDir/envs/r_env/environment.yaml"
                cpus = 1
            }
        }
    }

    esrum {
        params {
            outputDir = "/home/projects/$params.project/scratch/nextflow"
            project = ""
        }

        process {
            executor = 'slurm'
            queueSize = 10
            beforeScript = "export _JAVA_OPTIONS=-Djava.io.tmpdir=$params.outputDir"
        }
    }

    ngc {
        params {
            outputDir = "results"
            project = "icope_staging_r"
            cacheDir = "/home/projects/$params.project/scratch/nextflow"
        }

        process {
            executor = 'pbs'
            queueSize = 30
            beforeScript = "export _JAVA_OPTIONS=-Djava.io.tmpdir=$params.cacheDir"
            clusterOptions = "-A $params.project -W group_list=$params.project"
            
            withLabel: 'low_req' {
                executor = 'local'
            }

            withName: FASTQC {
                module = ['tools','java/1.8.0-openjdk','perl/5.30.2','fastqc/0.11.8']
                cpus = 1
                memory = 4.GB
                time = 2.hour
            }

            withName: ALIGNMENT {
                module = ['tools','bwa-mem2/2.2.1','samtools/1.18']
                cpus = 40
                memory = 180.GB
                time = 2.hour
            }

            withName: MARKDUPLICATES {
                module = ['tools','java/1.8.0-openjdk','gatk/4.3.0.0']
                cpus = 1
                memory = 4.GB
                time = 2.hour
            }

            withName: CLEAN {
                module = ['tools','samtools/1.18']
                cpus = 2
                memory = 3.GB
                time = 2.hour
            }

            withName: ADDREADGROUP {
                module = ['tools','java/1.8.0-openjdk','gatk/4.3.0.0']
                cpus = 1
                memory = 4.GB
                time = 2.hour
            }

            withName: INDEX {
                module = ['tools','samtools/1.18']
                cpus = 2
                memory = 3.GB
                time = 2.hour
            }

            withName: VALIDATE {
                module = ['tools','java/1.8.0-openjdk','gatk/4.3.0.0']
                cpus = 1
                memory = 4.GB
                time = 2.hour
            }

            withName: HAPLOTYPECALLER {
                module = ['tools','java/1.8.0-openjdk','gatk/4.3.0.0']
                cpus = 1
                memory = 4.GB
                time = 2.hour
            }

            withName: INDELQUAL {
                module = ['tools','anaconda2/4.4.0','lofreq/2.1.3.1']
                cpus = 1
                memory = 4.GB
                time = 2.hour
            }

            withName: LOFREQ {
                module = ['tools','anaconda2/4.4.0','lofreq/2.1.3.1']
                cpus = 1
                memory = 4.GB
                time = 2.hour
            }
            
            withName: PINNING {
                module = ['tools','gcc/7.4.0','intel/perflibs/2020_update4','R/4.3.0']
                cpus = 1
                memory = 10.GB
                time = 1.hour
            }
        }
    }

    test {
        params {
            pooltable = "$projectDir/assets/test_data/simulated_samples/sim_2x2/pooltable.tsv"
            decodetable = "$projectDir/assets/test_data/simulated_samples/sim_2x2/decodetable.tsv"
            reference_genome = "$projectDir/assets/test_data/reference_genomes/small/small_reference"
            bedfile = "$projectDir/assets/test_data/simulated_samples/sim_2x2/target_calling.bed"
            ploidy = 1
        }
    }
}
